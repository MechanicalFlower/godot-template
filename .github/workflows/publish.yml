name: Publish

# Only trigger, when the build workflow succeeded
on:
  workflow_run:
    workflows: ["Build"]
    types: [completed]

env:
  BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}

jobs:
  set_tag_name:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-22.04

    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}
    steps:
      - name: Check Tag
        id: tag
        run: |
          if [[ ${{ env.BRANCH_NAME }} =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "tag_name=${{ env.BRANCH_NAME }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag_name=null" >> "$GITHUB_OUTPUT"
          fi

  create_release:
    needs: set_tag_name
    if: ${{ needs.set_tag_name.outputs.tag_name != 'null' }}
    runs-on: ubuntu-22.04

    name: Create Release
    steps:
      - name: Create release
        run: |
          gh release create "${{ env.BRANCH_NAME }}" \
              --repo="${{ github.repository }}" \
              --title="v${{ env.BRANCH_NAME }}" \
              --generate-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    needs: create_release
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            preset: Windows Desktop

          - platform: linux
            preset: Linux/X11

          # - platform: web
          #   preset: Web

          - platform: mac
            preset: macOS

    name: ${{ matrix.preset }} Publish
    steps:
      - name: Download artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: ${{ github.event.workflow_run.workflow_id }}
          name: Greeter-${{ matrix.platform }}-v${{ env.BRANCH_NAME }}
          path: dist/${{ matrix.platform }}
          skip_unpack: true

      - name: Upload to release
        run: |
          gh release upload "${{ env.BRANCH_NAME }}" \
            --repo="${{ github.repository }}" \
            --clobber \
            dist/${{ matrix.platform }}/Greeter-${{ matrix.platform }}-v${{ env.BRANCH_NAME }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to itch.io
        uses: josephbmanley/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_API_KEY }}
          CHANNEL: ${{ matrix.platform }}
          ITCH_GAME: greeter
          ITCH_USER: mechanical-flower
          PACKAGE: dist/${{ matrix.platform }}/Greeter-${{ matrix.platform }}-v${{ env.BRANCH_NAME }}.zip
          VERSION: ${{ env.BRANCH_NAME }}
